---
title: "Midterm-Project_ST5226"
author: "Name: Zhu Xu; User ID:E0337988; Student ID:A0191344H"
date: "13 October 2018"
output:
  pdf_document:
    latex_engine: xelatex
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
\linespread{1.2}
\rule[-5pt]{16.3cm}{0.15em}

###$\quad$Sudden Infant Death Syndrome (SIDS) refers to the sudden unexplained death of a child less than one year of age. The data is contained in NC\_4.rds. The SpatialPolygonsDataFrame nc contains counts of the number of live births (BIR74) and SIDS (SID74) cases in the 100 counties of North Carolina for the period July 1, 1974 to June 30, 1978.

###Question-1:
$\quad$Interpret the raw.rates vector that is being computed below:\newline
\> nc\$raw.rates <- nc\$SID74 / nc\$BIR74 / 4 \* 1e04

###Solution-1:
```{r}
library(sp)
nc <- readRDS("C:/Users/MSI/Desktop/Notes/ST5226-Spatial Statistics/Mid-project/nc_4.rds")
#nc$SID74---the number of live births during 4 years.(SID74)
#nc$BIR74---the number of SIDS cases during 4 years.(BIR74)
```
nc\$raw.rates <- nc\$SID74/nc\$BIR74/4*1e04\newline
$\quad$It means: $\frac{death}{birth}\times\frac{1}{4}\times 10^4$, i.e. the number of SIDS cases per year per $10^4$ births.\newline

###Question-2:
$\quad$Plot raw rates in chloropleth map. Explain why some smoothing of the rates is necessary.

###Solution-2:
```{r, warning = FALSE, message = FALSE}
library(mice)
str(nc, max.level = 2)
str(slot(nc,"data"), max.level = 1)
```
\newpage
```{r}
raw_data <- slot(nc, "data")[, c("SP_ID", "SID74", "BIR74")]
md.pattern(raw_data) # display missing-data patterns in raw_data
```
\newpage
```{r, warning = FALSE, message = FALSE}
library(Hmisc)
#locate the missing-data and fill in missing value with median
nc$SID74 <- impute(nc$SID74,median)  #nc[["SID74"]][4] <- impute(raw_data$SID74,median) 
```

```{r}
nc_data <- slot(nc, "data")[, c("SP_ID", "SID74", "BIR74")]
nc$raw.rates <- nc$SID74/nc$BIR74/4*1e04 #compute the raw.rates
```

```{r, warning = FALSE, message = FALSE}
library(RColorBrewer)
library(classInt)
pal <- brewer.pal(n=5, "Reds")
intervals <- classIntervals(nc$raw.rates, n=5, "fisher")
intervals$brks[6] <- 16
#make a chloropleth map of raw rates
figure_raw.rates <- spplot(
  nc, c("raw.rates"), col.regions=pal, at=intervals$brks, main="SIDS Raw Rates")
figure_raw.rates
```
\newpage
```{r}
hist(nc$raw.rates, breaks=20, xlab="Raw Rates", 
     main="Histogram of Raw Rates", col="lightsteelblue")
nc_data[nc_data$SID74 == 0, ]
```
\newpage
```{r}
#make a histogram of the number of births
hist(nc$BIR74, breaks=20, xlab="The number of births", 
     main="Histogram of BIR74", col="grey")
```

$\quad$ we can clearly see we are being impacted by the small number problem, i.e. there are
regions with very small counts and small population sizes. Moreover the distribution of population
sizes is quite skewed. So some of smoothing of the rates is necessary.\newline

\newpage

###Question-3:
$\quad$Consider smoothing the raw rates using the weighted average smoother we covered in class. Propose the weights that you think best for this data. Explain your result.

###Solution-3:

```{r}
distance <- spDists(coordinates(nc), longlat=T)
hist(distance, breaks=20,xlim=c(0,800), col="grey")
```

$\quad$ So we choose the distance = 50 km
\newpage

###Method_1: $(d_{ij}=50, w_{ij}=1\quad or\quad 0)$

$\quad$ Consider smoothing the raw rates using the expression below:
\begin{center}
$\hat{r_i}=\frac{\sum_{j=1}^{100}w_{ij}Y_j}{\sum_{j=1}^{100}w_{ij}n_j}$
\end{center}
where

$\qquad\hat{r_i}$ is the smoothed rate for county i.

$\qquad w_{ij}$ is the smoothing weight
\begin{equation*}
w_{ij}=\left\{
\begin{aligned}
&1, d_{ij}\leq 50\\
&0, d_{ij} > 50
\end{aligned}
\right.
\end{equation*}
$\qquad d_{ij}$ is the distance in kilometres between i and j.

$\qquad Y_j$ is the number of SIDS cases in county j.

$\qquad n_j$ is the number of births in county j.

```{r}
w_ij_1 <- ifelse(distance<=50, 1, 0)
nc$smoothed_rates_1 <- as.vector(w_ij_1 %*% nc$SID74 / w_ij_1 %*% nc$BIR74 /4 *1e04)
intervals_a <- classIntervals(nc$smoothed_rates_1, n=5, "fisher")
intervals_a$brks[6] <- 14
figure_smoothing_1 <- spplot(
  nc, "smoothed_rates_1", col.regions=pal, at=intervals_a$brks, main="Smoothing-1")
```
\newpage
```{r}
figure_smoothing_1
```

\newpage
###Method_2: $(d_{ij}=50, w_{ij}=[1-(\frac{d_{ij}}{50})^3]^3\quad or\quad 0)$

$\quad$ Consider smoothing the raw rates using the expression below:
\begin{center}
$\hat{r_i}=\frac{\sum_{j=1}^{100}w_{ij}Y_j}{\sum_{j=1}^{100}w_{ij}n_j}$
\end{center}
where

$\qquad w_{ij}$ is the smoothing weight
\begin{equation*}
w_{ij}=\left\{
\begin{aligned}
&[1-(\frac{d_{ij}}{50})^3]^3, d_{ij}\leq 50\\
&0, \qquad\qquad\quad d_{ij} > 50
\end{aligned}
\right.
\end{equation*}

```{r}
w_ij_2 <- ifelse(distance<=50, (1-(distance/50)^3)^3, 0)
nc$smoothed_rates_2 <- as.vector(w_ij_2 %*% nc$SID74 / w_ij_2 %*% nc$BIR74 /4 *1e04)
intervals_b <- classIntervals(nc$smoothed_rates_2, n=5, "fisher")
intervals_b$brks[6] <- 14
figure_smoothing_2 <- spplot(
  nc, "smoothed_rates_2", col.regions=pal, at=intervals_b$brks, main="Smoothing-2")
figure_smoothing_2
```

\newpage
###Method_3:(Empirical Bayes)

```{r, warning = FALSE, message = FALSE}
library(spdep)
library(rgdal)
nc$smoothed_rates_eb <- EBest(nc$SID74, nc$BIR74)$estmm /4 *1e04
intervals_eb <- classIntervals(nc$smoothed_rates_eb, n=5, "fisher")
intervals_eb$brks[6] <- 10
figure_smoothing_eb <- spplot(
  nc, "smoothed_rates_eb", col.regions=pal, at=intervals_eb$brks, main="Smoothing-eb")
figure_smoothing_eb
```

\newpage
###Question-4:
$\quad$Compare your proposed smoother with the raw rates using chloropleth map. Interpret your discoveries.

###Solution-4:

```{r, warning = FALSE, message = FALSE}
figure_raw.rates
```
\newpage
```{r}
figure_smoothing_1
```
\newpage
```{r}
figure_smoothing_2
```
\newpage
```{r}
figure_smoothing_eb
```
\newpage
```{r}
par(mfrow=c(2,2))
hist(nc$raw.rates, breaks=20, xlab="Raw Rates", 
     xlim=c(0,15), main="Histogram of Raw Rates", col="lightsteelblue")
hist(nc$smoothed_rates_1, breaks=20, xlab="Smoothed Rates 1", 
     xlim=c(0,15), main="Histogram of Smoothed Rates-1", col="lightsteelblue")
hist(nc$smoothed_rates_2, breaks=20, xlab="Smoothed Rates 2", 
     xlim=c(0,15), main="Histogram of Smoothed Rates-2" , col="lightsteelblue")
hist(nc$smoothed_rates_eb, breaks=20, xlab="Smoothed Rates eb", 
     xlim=c(0,15), main="Histogram of Smoothed Rates-eb", col="lightsteelblue")
```

$\quad$ We can assume that, $Y_j \sim Possion(\xi n_j)$ for all counties within 50 km.\newline
Then:
\begin{center} 
$Var(\hat{r_i})=\frac{\sum w_{ij}^2 \xi n_j}{(\sum w_{ij} \xi n_j)^2}\leq\frac{\sum w_{ij} \xi n_j}{(\sum w_{ij} \xi n_j)^2}=\frac{\xi}{\sum w_{ij} \xi n_j}\leq\frac{\xi}{n_j}=Var(\frac{Y_i}{n_j})$
\end{center}
$\quad$ It's clear that the smoothed map has a smaller range, and provides a clearer suggestion of regions that should be studied further.We can see the $var(\hat{r_{i2}})$ of method-2 < the $var(\hat{r_{i1}})$ of method-1 via the histograms of smoothed rates, and there is an interesting note that using method-3(EB) we could get a "better" result, but actually the smoothed rates range is too small and method-3 is over-smoothing.So,the method-2, i.e.$w_{ij}=[1-(\frac{d_{ij}}{50})^3]^3$ is more suitable.







